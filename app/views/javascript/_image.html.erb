<script>
$(document).ready(function() { 
    // Image Pop Up

    $(".edit_image input[type=checkbox]").click(function() {
        $(this).parent("form").submit()
    })
        

    $(".thumbnail img").dblclick(function(e){
        $('.actions').hide()
        $("#background").css({"opacity" : "0.7"})
                        .fadeIn("slow");
        $("#large").html("<img src='"+$(this).attr("data-src")+"' alt='"+$(this).attr("alt")+"' /><br/>"+$(this).attr("data-content")+"")
                   .center()
                   .fadeIn("slow");
        return false;
    }); 

    $('.actions').hide()
    
    $("#background").dblclick(function(){
        $("#background").fadeOut("slow");
        $("#large").fadeOut("slow");
        $("#photo_form").fadeOut("slow")
        $("#edit_container").fadeOut("slow")
    });

    $("#large").dblclick(function(){
        $("#background").fadeOut("slow");
        $("#large").fadeOut("slow");
    });

    $(".thumb_drag").draggable({
        containment: ".master_container",
        revert: "valid"
    })

    $(".photos_container").droppable({
        accept: ".thumb_drag",
        drop: function(event, ui) {
            var user_id = <%= current_user.id %>
            var img_id = ui.draggable.attr("data-id")
            var image = ui.draggable.attr("data-image")
            var range = ui.draggable.attr("data-range")
            var beg_range = ui.draggable.attr("data-beg")
            var end_range = ui.draggable.attr("data-end")
            var coordinates = [50, 400]
            var data = {}
            var URL = "http://localhost:3000/users/"+user_id+"/images/"+img_id+"/update"

            data[range] = true;
            data[range+'_p'] = coordinates.join(",")
            DATA = { image: data };
            
            $.ajax({
                url: URL,
                type: "put",
                data: DATA,
                success: function() {
                    var refresh = range+"?beg_range="+beg_range+"&end_range="+end_range
                    window.location.href = refresh
                }
            })
        }
    })

    $(".photo_btn").toggle(function() {
        $("#background").css({"opacity" : "0.7"})
                        .fadeIn("slow");
        date = $(this).attr("data-date")
        user_id = <%= current_user.id %>
        URL = "/users/"+user_id+"/images/new"
        $.ajax({
            url: URL,
            type: 'get',
            data: { image: {date_taken: date}}
        });
        return false;
    }, function() {
        $(this).prev("#photo_form").hide()
        $("#background").fadeOut("slow")
    })

    $(".journal_btn").toggle(function() {
        user_id = <%= current_user.id %>
        date = $(this).attr("data-date")
        range = $(this).attr("data-range")
        data = {}
        data['entry_date'] = date
        data[range] = true
        URL = "http://localhost:3000/users/"+user_id+"/journals/new"
        $.ajax({
            url: URL,
            type: 'get',
            data: {journal: data}
        });
        return false;
    }, function() {
        $(this).prev("#journal_form").hide()
    })

    $(".edit_msg").click(function(){
        user_id = <%= current_user.id %>
        bread_crumb = $(this).attr("data-crumb")
        img_id = $(this).attr("data-id")
        URL = "http://localhost:3000/users/"+user_id+"/images/"+img_id+"/edit?bread_crumb="+bread_crumb
        $.ajax({
            url: URL,
            type: 'get'
        })
    })

   // Drag
    $(".drag_msg").toggle(function() {
        var user_id = <%= current_user.id %>
        var img_id = $(this).attr("data-id")
        var page = $(this).attr("data-range")
        var this_image = $(this)
        var img_position = this_image.position()
        var left = img_position.left
        var top = img_position.top
        
        $(".cp").hide()
        $(this).show()
        $(this).parent().children(".message").html("Image is now draggable").show()
        $(".p_left").html(left);
        $(".p_top").html(top);
        this_image.parent().css("background", "#D53838")
        this_image.parent().parent().draggable({
            disabled: false,
            containment: $(".photos_container"),
            stop: function() {
                var URL = "http://localhost:3000/users/"+user_id+"/images/"+img_id+"/drag"
                $.ajax({
                    url: URL,
                    type: 'put',
                    data: this_image.get_range(),
                    success: function() {
                        $(".gallery_msg").fadeOut(4000)
                        $(".cp").show()
                        this_image.parent().children(".message").html("Positioning successful").fadeOut(2000)
                        this_image.parent().parent().draggable("option", "disabled", true)
                        this_image.parent().parent().css("opacity", "1")
                        this_image.parent().css("background", "#9E9E9E")
                    }
                })
            } // end stop function
        }) // end draggable
    }, function() {
        $(".cp").show()
        $(this).parent().children(".message").html("").hide()
        $(this).parent().parent().draggable("option", "disabled", true)
        $(this).parent().parent().css("opacity", "1")
        $(this).parent().css("background", "#9E9E9E")
    })

    // grab the new position coordinate after drag and update db
    jQuery.fn.get_range = function() {
        var new_position = $(this).parent().parent().position()
        var new_left = new_position.left
        var new_top = new_position.top
        var coordinates = [new_left, new_top]
        var range = $(this).attr("data-range");
        var data = {};

        data[range+'_p'] = coordinates.join(",")
        DATA = {image: data }
        return DATA
    }

     jQuery.fn.get_new_dimensions = function() {
        var endW = $(event.target).innerWidth();
        var endH = $(event.target).innerHeight();
        var WH = [endW, endH];
        var range = $(this).attr("data-range");
        var data = {};
        
        data[range+'_dim'] = WH.join(",");
        DATA = { image: data };
        return DATA;
    }

    // RESIZE 
    $(".resize_msg").toggle(function() {
        // get original dimensions of image coming in
        user_id = <%= current_user.id %>
        img_id = $(this).attr("data-id") 
        var this_button = $(this)
        var this_image = $(this).parent().next(".resizable");
        var image_width = this_image.innerWidth();  
        var image_height = this_image.innerHeight();
        var ratio = image_height/image_width;  //Define image ratio
        this_button.parent().css("background", "#D53838")
        $(".cp").hide()
        $(this).show()
        $(this).parent().children(".message").html("Image is now resizable").show()
        // allows user to resize while keeping original aspectRatio
        this_image.resizable({
            aspectRatio: 1/ratio,
            ghost: true,
            stop: function(event, ui) {
              
              var URL = "http://localhost:3000/users/"+user_id+"/images/"+img_id+"/resize"
              $.ajax({
                   url: URL,
                   type: 'put',
                   data: this_image.get_new_dimensions(),
                   success: function() {
                        $(".cp").show()
                        this_button.parent().children(".message").html("Resize successful").fadeOut(2000)
                        this_image.resizable("destroy")
                        this_button.parent().parent().css("opacity", "1")
                        this_button.parent().css("background", "#9E9E9E")

                   }
              })
           }
        })
    }, function() {
        $(".cp").show()
        $(this).parent().children(".message").html("").hide()        
        $(this).parent().css("background", "#9E9E9E")
    });

    $(".image_container").hover(function() {
        $(this).children(":first").show()
    }, function(){
        $(this).children(":first").hide()
    })

    $(".crop_msg").click(function() {
        bread_crumb = $(this).attr("data-crumb")
        user_id = <%= current_user.id %>
        img_id = $(this).attr("data-id")
        range = $(this).attr("data-range")
        parameters = "?bread_crumb="+bread_crumb+"&range="+range
        URL = "http://localhost:3000/users/"+user_id+"/images/"+img_id+"/edit"+parameters
        window.location.href = URL
    })
    
    $(".time_navigation").show()
    $(".time_nav_btn").click(function() {
        $(".time_navigation").show()
    })

    $(".delete_time_nav").click(function() {
        $(".time_nav_btn").show()
        $(".time_navigation").addClass("hide")
    }) 
});
</script>